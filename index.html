<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>醫學教育 AI 數位賦能工作坊｜報名系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <meta name="color-scheme" content="light only">
  <style>
    :root{
      --bg1:#e6f7f6; /* very light teal */
      --bg2:#d2f1ef; /* mint */
      --accent:#0ea5a7; /* teal 500 */
      --accent-2:#14b8a6; /* teal 400 */
      --glass-bg: 255,255,255; /* rgb for backdrop */
    }
    html,body{height:100%}
    body{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";}
    /* 科技清新：柔和漸層＋粒子 */
    .tech-bg{
      background: radial-gradient(1200px 800px at 10% 10%, #ffffff66 0%, #ffffff00 60%),
                  radial-gradient(800px 600px at 90% 20%, #ffffff55 0%, #ffffff00 60%),
                  linear-gradient(135deg, var(--bg1), var(--bg2));
      position: relative;
      overflow: hidden;
    }
    .particle{ position:absolute; width:8px; height:8px; border-radius:9999px; background:#fff; opacity:.5; filter:blur(1px); animation: float 12s ease-in-out infinite; }
    @keyframes float{ 0%{ transform: translateY(0)} 50%{ transform: translateY(-30px)} 100%{ transform: translateY(0)} }
    /* 玻璃霧面卡片 */
    .glass{
      background: rgba(var(--glass-bg), .55);
      backdrop-filter: blur(14px) saturate(140%);
      -webkit-backdrop-filter: blur(14px) saturate(140%);
      border: 1px solid rgba(255,255,255,.35);
      box-shadow: 0 10px 30px -10px rgba(20, 184, 166, .25);
    }
    .tab-active{ color: white; background: linear-gradient(135deg, var(--accent), var(--accent-2)); }
    .tab-inactive{ color: #0f766e; background: rgba(20,184,166,.1); }
    .shadow-soft{ box-shadow: 0 20px 60px -20px rgba(14,165,167,.35); }
    .btn-primary{ background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:white; }
    .btn-primary:disabled{ filter: grayscale(60%); opacity:.6; cursor:not-allowed; }
    .badge{ background: rgba(20,184,166,.12); color:#0f766e; border:1px solid rgba(20,184,166,.25) }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
  </style>
</head>
<body class="tech-bg min-h-screen">
  <!-- 背景粒子（裝飾） -->
  <div class="particle" style="left:6%; top:18%; animation-delay:.2s"></div>
  <div class="particle" style="left:80%; top:30%; animation-delay:1.3s"></div>
  <div class="particle" style="left:30%; top:80%; animation-delay:.9s"></div>

  <header class="max-w-5xl mx-auto px-4 pt-10 pb-4">
    <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight text-teal-800">醫學教育 AI 數位賦能工作坊｜報名系統</h1>
    <p class="mt-2 text-teal-700">以 Google Apps Script Web App 寫入 Google 試算表、即時統計名額，額滿自動鎖定。</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-20 grid gap-6 md:grid-cols-3">
    <!-- 活動資訊卡片 -->
    <section class="glass rounded-2xl p-6 md:col-span-1 shadow-soft">
      <h2 class="text-lg font-semibold text-teal-900 flex items-center gap-2"><span class="inline-block w-2 h-2 rounded-full bg-teal-500"></span> 活動資訊</h2>
      <dl class="mt-4 space-y-3 text-teal-800">
        <div class="flex items-center justify-between"><dt class="font-semibold">時間</dt><dd>114/11/23</dd></div>
        <div class="flex items-center justify-between"><dt class="font-semibold">地點</dt><dd>奇美博物館</dd></div>
        <div class="flex items-center justify-between"><dt class="font-semibold">聯絡人</dt><dd>000</dd></div>
      </dl>
      <div class="mt-6 flex flex-wrap gap-2">
        <span class="px-2.5 py-1 rounded-full text-xs badge">科技清新</span>
        <span class="px-2.5 py-1 rounded-full text-xs badge">玻璃霧面</span>
        <span class="px-2.5 py-1 rounded-full text-xs badge">GAS＋Sheet</span>
      </div>
    </section>

    <!-- 報名表區域 -->
    <section class="glass rounded-2xl p-6 md:col-span-2 shadow-soft">
      <!-- Tabs -->
      <div class="inline-flex rounded-xl overflow-hidden border border-teal-200">
        <button id="tab-in" class="px-4 py-2 text-sm font-semibold tab-active">院內人員</button>
        <button id="tab-out" class="px-4 py-2 text-sm font-semibold tab-inactive">院外人員</button>
      </div>

      <!-- 名額顯示 -->
      <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
        <div class="p-3 rounded-xl border border-white/60 bg-white/50">
          <div class="text-xs text-teal-700">院內名額</div>
          <div class="text-2xl font-extrabold text-teal-900" id="cap-in">30</div>
        </div>
        <div class="p-3 rounded-xl border border-white/60 bg-white/50">
          <div class="text-xs text-teal-700">院內剩餘</div>
          <div class="text-2xl font-extrabold text-teal-900" id="left-in">—</div>
        </div>
        <div class="p-3 rounded-xl border border-white/60 bg-white/50">
          <div class="text-xs text-teal-700">院外名額</div>
          <div class="text-2xl font-extrabold text-teal-900" id="cap-out">20</div>
        </div>
        <div class="p-3 rounded-xl border border-white/60 bg-white/50">
          <div class="text-xs text-teal-700">院外剩餘</div>
          <div class="text-2xl font-extrabold text-teal-900" id="left-out">—</div>
        </div>
      </div>

      <!-- 院內表單 -->
      <form id="form-in" class="mt-6 space-y-4">
        <input type="hidden" name="role" value="internal" />
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-teal-900">姓名<span class="text-rose-500">*</span></label>
            <input required name="name" type="text" placeholder="王小明" class="mt-1 w-full rounded-xl border border-teal-200/60 bg-white/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-400">
          </div>
          <div>
            <label class="block text-sm font-medium text-teal-900">Email<span class="text-rose-500">*</span></label>
            <input required name="email" type="email" placeholder="example@hospital.org" class="mt-1 w-full rounded-xl border border-teal-200/60 bg-white/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-400">
          </div>
          <div>
            <label class="block text-sm font-medium text-teal-900">科別／單位<span class="text-rose-500">*</span></label>
            <input required name="dept" type="text" placeholder="內科部" class="mt-1 w-full rounded-xl border border-teal-200/60 bg-white/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-400">
          </div>
          <div>
            <label class="block text-sm font-medium text-teal-900">聯絡電話</label>
            <input name="phone" type="tel" placeholder="0912-345-678" class="mt-1 w-full rounded-xl border border-teal-200/60 bg-white/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-400">
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="btn-in" type="submit" class="btn-primary rounded-xl px-5 py-2.5 font-semibold shadow-soft transition active:scale-[.99]">提交院內報名</button>
          <span id="hint-in" class="text-sm text-teal-700"></span>
        </div>
      </form>

      <!-- 院外表單 -->
      <form id="form-out" class="mt-6 space-y-4 hidden">
        <input type="hidden" name="role" value="external" />
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-teal-900">姓名<span class="text-rose-500">*</span></label>
            <input required name="name" type="text" placeholder="林小美" class="mt-1 w-full rounded-xl border border-teal-200/60 bg-white/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-400">
          </div>
          <div>
            <label class="block text-sm font-medium text-teal-900">Email<span class="text-rose-500">*</span></label>
            <input required name="email" type="email" placeholder="example@mail.com" class="mt-1 w-full rounded-xl border border-teal-200/60 bg-white/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-400">
          </div>
          <div>
            <label class="block text-sm font-medium text-teal-900">服務單位／學校<span class="text-rose-500">*</span></label>
            <input required name="org" type="text" placeholder="○○醫院／○○大學" class="mt-1 w-full rounded-xl border border-teal-200/60 bg-white/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-400">
          </div>
          <div>
            <label class="block text-sm font-medium text-teal-900">聯絡電話</label>
            <input name="phone" type="tel" placeholder="0912-345-678" class="mt-1 w-full rounded-xl border border-teal-200/60 bg-white/60 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-400">
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button id="btn-out" type="submit" class="btn-primary rounded-xl px-5 py-2.5 font-semibold shadow-soft transition active:scale-[.99]">提交院外報名</button>
          <span id="hint-out" class="text-sm text-teal-700"></span>
        </div>
      </form>
    </section>
  </main>

  <!-- 成功/失敗提示：Dialog -->
  <dialog id="dlg-success" class="rounded-2xl p-0 w-[min(92vw,520px)]">
    <div class="glass rounded-2xl p-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-emerald-100 text-emerald-700">✔</div>
        <h3 class="text-lg font-semibold text-teal-900">報名成功</h3>
      </div>
      <p class="mt-2 text-teal-800">您的資料已送出，我們已寄出確認通知（若有設定）。</p>
      <div class="mt-4 text-right">
        <button class="px-4 py-2 rounded-xl border border-teal-200 bg-white/70 text-teal-800" onclick="document.getElementById('dlg-success').close()">關閉</button>
      </div>
    </div>
  </dialog>

  <dialog id="dlg-fail" class="rounded-2xl p-0 w-[min(92vw,520px)]">
    <div class="glass rounded-2xl p-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-rose-100 text-rose-700">!</div>
        <h3 class="text-lg font-semibold text-teal-900">報名失敗</h3>
      </div>
      <p id="fail-msg" class="mt-2 text-teal-800">很抱歉，送出時發生問題，請稍後再試。</p>
      <div class="mt-4 text-right">
        <button class="px-4 py-2 rounded-xl border border-teal-200 bg-white/70 text-teal-800" onclick="document.getElementById('dlg-fail').close()">關閉</button>
      </div>
    </div>
  </dialog>

  <footer class="max-w-5xl mx-auto px-4 pb-12 text-xs text-teal-700/80">
    <p>© 2025 報名系統示例（Tailwind＋Google Apps Script）</p>
  </footer>

  <script>
    // ======== 可調整參數 ========
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx31TX7lN2_3_zSJmw1BDhz17WimVXZyiWHG7qpl3-WiO83VPs7EQZgp5W5vFcdpnmG/exec"; // ← 替換為你的 Web App URL
    const CAP = { internal: 30, external: 20 };

    // ======== DOM ========
    const tabIn = document.getElementById('tab-in');
    const tabOut = document.getElementById('tab-out');
    const formIn = document.getElementById('form-in');
    const formOut = document.getElementById('form-out');
    const btnIn = document.getElementById('btn-in');
    const btnOut = document.getElementById('btn-out');
    const hintIn = document.getElementById('hint-in');
    const hintOut = document.getElementById('hint-out');

    const capIn = document.getElementById('cap-in');
    const capOut = document.getElementById('cap-out');
    const leftIn = document.getElementById('left-in');
    const leftOut = document.getElementById('left-out');

    const dlgSuccess = document.getElementById('dlg-success');
    const dlgFail = document.getElementById('dlg-fail');
    const failMsg = document.getElementById('fail-msg');

    // ======== Tab 切換 ========
    function setTab(active){
      const isIn = active === 'in';
      tabIn.classList.toggle('tab-active', isIn);
      tabIn.classList.toggle('tab-inactive', !isIn);
      tabOut.classList.toggle('tab-active', !isIn);
      tabOut.classList.toggle('tab-inactive', isIn);
      formIn.classList.toggle('hidden', !isIn);
      formOut.classList.toggle('hidden', isIn);
    }
    tabIn.addEventListener('click', ()=> setTab('in'));
    tabOut.addEventListener('click', ()=> setTab('out'));

    // ======== 名額查詢 ========
    async function fetchCounters(){
      // 預期回傳格式：{ success:true, counts:{ internal:已報名數, external:已報名數 } }
      try{
        const url = new URL(GAS_URL);
        url.searchParams.set('action','counts');
        const res = await fetch(url, { method:'GET', mode:'cors' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(!data.success) throw new Error(data.message || 'unknown error');
        return data.counts || { internal: 0, external: 0 };
      }catch(err){
        console.warn('[counts] fallback to localStorage mock:', err.message);
        // 若無法連線，使用 localStorage 模擬（僅供展示，正式請移除）
        const m = JSON.parse(localStorage.getItem('mockCounts')||'{"internal":0,"external":0}');
        return m;
      }
    }

    function updateRemaining(counts){
      const left_i = Math.max(0, CAP.internal - (counts.internal||0));
      const left_e = Math.max(0, CAP.external - (counts.external||0));
      leftIn.textContent = left_i;
      leftOut.textContent = left_e;
      // 額滿鎖定
      btnIn.disabled = left_i <= 0;
      btnOut.disabled = left_e <= 0;
      hintIn.textContent = left_i <= 0 ? '（名額已滿）' : '';
      hintOut.textContent = left_e <= 0 ? '（名額已滿）' : '';
    }

    // ======== 報名送出 ========
    async function submitForm(formEl, btnEl){
      const fd = new FormData(formEl);
      const payload = Object.fromEntries(fd.entries());
      btnEl.disabled = true; btnEl.dataset.oldText = btnEl.textContent; btnEl.textContent = '送出中…';
      try{
        const res = await fetch(GAS_URL, {
          method:'POST',
          mode:'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action:'register', data: payload })
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        if(!data.success) throw new Error(data.message || 'register failed');

        // 刷新名額
        const counts = data.counts || await fetchCounters();
        updateRemaining(counts);

        // 清表單 & 成功視窗
        formEl.reset();
        dlgSuccess.showModal();
      }catch(err){
        console.error(err);
        failMsg.textContent = '送出失敗：' + err.message + '（請稍後重試或聯絡主辦單位）';
        dlgFail.showModal();
      }finally{
        btnEl.disabled = false; btnEl.textContent = btnEl.dataset.oldText || '提交';
      }
    }

    formIn.addEventListener('submit', (e)=>{ e.preventDefault(); submitForm(formIn, btnIn); });
    formOut.addEventListener('submit', (e)=>{ e.preventDefault(); submitForm(formOut, btnOut); });

    // ======== 初始化 ========
    (async function init(){
      capIn.textContent = CAP.internal;
      capOut.textContent = CAP.external;
      setTab('in');
      const counts = await fetchCounters();
      updateRemaining(counts);
    })();
  </script>
</body>
</html>
